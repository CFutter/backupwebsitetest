---
import { getCollection } from "astro:content";

/** Collect content entries that should appear in navigation */
const entries = await getCollection("pages", ({ data }) => data.showInNav !== false);

/** Current URL path for top-level active state */
const { pathname } = Astro.url;

/** UI section keys (must match data-subpages on primary links) */
const groups = ["home", "spaces", "explore", "about"] as const;
type Group = (typeof groups)[number];

/** Subpage item shape we keep server-side and (optionally) expose to client */
type SubItem = { href: string; label: string; icon?: string; order: number };

/** Buckets by section */
const subpagesByGroup: Record<Group, SubItem[]> = {
  home: [],
  spaces: [],
  explore: [],
  about: [],
};

/** Build subpage lists from collection slugs like: "about/data-archive", "home/news" */
for (const { slug, data } of entries) {
  const [folder, ...rest] = slug.split("/"); // e.g., ["home","news"]
  if (!folder || rest.length === 0) continue;

  const group = folder as Group;              // now folder == section key
  if (!groups.includes(group)) continue;

  const last = rest.join("/");                // "news"
  subpagesByGroup[group].push({
    href: `/${group}/${last}`,                // "/home/news"
    label: data.navLabel ?? data.title,       // <-- prefer navLabel over title
    icon: data.icon,
    order: typeof data.navOrder === "number" ? data.navOrder : 999,
  });
}

/** Sort: order asc, then label asc */
for (const g of groups) {
  subpagesByGroup[g].sort(
    (a, b) => a.order - b.order || a.label.localeCompare(b.label)
  );
}

/** Top-level links (single source) */
const primaryLinks = [
  { href: "/",        label: "Home",    key: "home",    icon: "homepage" },
  { href: "/spaces",  label: "Spaces",  key: "spaces",  icon: "spaces"   },
  { href: "/explore", label: "Explore", key: "explore", icon: "explore"  },
  { href: "/about",   label: "About",   key: "about",   icon: "about"    },
];
const secondaryLinks = [
  { href: "/account", label: "Account", icon: "account" },
  { href: "/contact", label: "Contact", icon: "contact" },
];

/** Legacy expose: arrays of hrefs (kept for backward compat if your JS still reads it) */
const SUBPAGES = {
  home:    subpagesByGroup.home.map((i) => i.href),
  spaces:  subpagesByGroup.spaces.map((i) => i.href),
  explore: subpagesByGroup.explore.map((i) => i.href),
  about:   subpagesByGroup.about.map((i) => i.href),
};

/** New expose: full items (href + label [+ icon, order]) */
const SUBPAGE_ITEMS = {
  home:    subpagesByGroup.home,
  spaces:  subpagesByGroup.spaces,
  explore: subpagesByGroup.explore,
  about:   subpagesByGroup.about,
};


/** Helper for top-level active state (treat section subpaths as active) */
const isActive = (base: string) => pathname === base || pathname.startsWith(base + "/");

/** Minimal, monochrome SVGs (stroke = currentColor) */

const ICONS: Record<string, string> = {
  // MAIN
  home: `
    <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor"
         stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M3 11.5l9-7 9 7"/>
      <path d="M5.5 12.5v8h5v-5h3v5h5v-8"/>
    </svg>
  `,
  spaces: `
    <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor"
         stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <rect x="3" y="3" width="7" height="7" rx="1"/>
      <rect x="14" y="3" width="7" height="7" rx="1"/>
      <rect x="3" y="14" width="7" height="7" rx="1"/>
      <rect x="14" y="14" width="7" height="7" rx="1"/>
    </svg>
  `,
  explore: `
    <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor"
         stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <circle cx="12" cy="12" r="9"/>
      <path d="M15 9l-3 7-1-3-3-1 7-3z"/>
    </svg>
  `,
  about: `
    <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor"
         stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <circle cx="12" cy="12" r="9"/>
      <path d="M12 10v6"/>
      <circle cx="12" cy="7" r="1" fill="currentColor"/>
    </svg>
  `,
  account: `
    <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor"
         stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <circle cx="12" cy="8" r="3"/>
      <path d="M5 19a7 7 0 0 1 14 0"/>
    </svg>
  `,
  contact: `
    <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor"
         stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <rect x="3" y="5" width="18" height="14" rx="2"/>
      <path d="M4 7l8 6 8-6"/>
    </svg>
  `,
};

const SUB_ICONS: Record<string, string> = {
  
  // ABOUT subpages
  blog: `
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
         stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M3 20h18"/>
      <path d="M6 17h6"/>
      <path d="M4 4l8 8"/>
      <path d="M14 6l4 4"/>
      <path d="M11 9l4-4"/>
    </svg>
  `,
  "data-archive": `
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
         stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <rect x="3" y="5" width="18" height="4" rx="1"/>
      <rect x="5" y="9" width="14" height="10" rx="2"/>
      <path d="M9 13h6"/>
    </svg>
  `,
  database: `
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
         stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <ellipse cx="12" cy="5" rx="7" ry="3"/>
      <path d="M5 5v6c0 1.7 3.1 3 7 3s7-1.3 7-3V5"/>
      <path d="M5 11v6c0 1.7 3.1 3 7 3s7-1.3 7-3v-6"/>
    </svg>
  `,
  github: `
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
         stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M6 18c4-2 8-2 12 0"/>
      <path d="M12 12v-2"/>
      <circle cx="12" cy="7" r="1"/>
      <path d="M8 12c-2 0-3-2-3-4 0-3 2.5-5 7-5s7 2 7 5c0 2-1 4-3 4"/>
    </svg>
  `,
  project: `
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
         stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M4 4h8l1 2h7v12H4z"/>
      <path d="M7 12h10"/>
    </svg>
  `,

  // EXPLORE subpages
  demographic: `
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
         stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <circle cx="7" cy="8" r="2"/>
      <path d="M3 18a4 4 0 0 1 8 0"/>
      <circle cx="17" cy="9" r="2"/>
      <path d="M13 18a4 4 0 0 1 8 0"/>
    </svg>
  `,
  financial: `
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
         stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M4 17l4-4 3 3 5-6 4 4"/>
      <path d="M3 20h18"/>
    </svg>
  `,
  historical: `
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
         stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <circle cx="12" cy="12" r="9"/>
      <path d="M12 7v6l4 2"/>
    </svg>
  `,
  political: `
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
         stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M7 10h10l1 7H6z"/>
      <path d="M5 7h14"/>
    </svg>
  `,

  // HOME subpages
  continue: `
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
         stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <circle cx="12" cy="12" r="9"/>
      <path d="M10 8l6 4-6 4z"/>
    </svg>
  `,
  news: `
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
         stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <rect x="3" y="5" width="15" height="14" rx="2"/>
      <path d="M18 7h2v10a2 2 0 0 1-2 2H6"/>
      <path d="M6 9h8M6 12h8M6 15h5"/>
    </svg>
  `,

  // SPACES subpages
  dossiers: `
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
         stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M4 7h6l2 2h8v11H4z"/>
      <path d="M4 7V4h6l2 2"/>
    </svg>
  `,
  stories: `
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
         stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M5 4h9a3 3 0 0 1 3 3v13H8a3 3 0 0 0-3 3z"/>
      <path d="M5 4v16a3 3 0 0 1 3-3h9"/>
    </svg>
  `,
};

---

<aside class="site-sidebar" data-component="site-sidebar">

  
  <!-- âœ… Brand logo (desktop only) -->
   
  <a class="site-brand site-brand--desktop" href="/" aria-label="Brand" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" aria-hidden="true">
    <svg viewBox="0 0 24 24" width="40" height="40" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" aria-hidden="true">
      <circle cx="12" cy="12" r="9"/>
      <path d="M3 12h18M12 3c2.7 3.3 2.7 14.7 0 18M5.2 7.5c4 2.2 9.6 2.2 13.6 0M5.2 16.5c4-2.2 9.6-2.2 13.6 0"/>
    </svg>
    <span class="sr-only">Your Brand</span>
  </a>


  <div class="site-bar">
    <!-- Hamburger -->
    <button class="site-menu-toggle" type="button" aria-label="Open menu" aria-controls="site-drawer" aria-expanded="false">
      <svg class="icon-burger" aria-hidden="true" viewBox="0 0 24 24" width="24" height="24">
        <path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" fill="none" />
      </svg>
    </button>
    <!-- Close -->
    <button class="site-menu-close" type="button" aria-label="Close menu" aria-controls="site-drawer" aria-expanded="false">
      <svg class="icon-arrow" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
        <line x1="4" y1="12" x2="16" y2="12" />
        <polyline points="10 8, 4 12, 10 16" />
        <line x1="20" y1="8" x2="20" y2="16" />
      </svg>
    </button>
  </div>

  <div class="site-drawer" id="site-drawer" data-open="false">
    
    <!-- Primary (centered vertically) -->
    <nav class="site-nav-primary" aria-label="Main">
      <ul class="site-nav">
        {primaryLinks.map((l) => (
          <li>
            <a
              href={l.href}
              {...(l.key ? { 'data-subpages': l.key } : {})}
              aria-current={pathname === l.href || pathname.startsWith(l.href + '/') ? 'page' : undefined}
            >
              <span class="nav-icon" aria-hidden="true" set:html={ICONS[l.icon] ?? ICONS.home}></span>
              <span class="nav-label">{l.label}</span>
            </a>
          </li>
        ))}
      </ul>
    </nav>

    <!-- Secondary (pinned to bottom) -->
    <nav class="site-nav-secondary" aria-label="Account and Contact">
      <ul class="site-nav">
        {secondaryLinks.map((l) => (
          <li>
            <a href={l.href}>
              <span class="nav-icon" aria-hidden="true" set:html={ICONS[l.icon] ?? ICONS.home}></span>
              <span class="nav-label">{l.label}</span>
            </a>
          </li>
        ))}
      </ul>
    </nav>
  </div>

  <div class="site-backdrop" hidden></div>
</aside>

<!-- Second sidebar -->
<aside class="sub-sidebar">
  <button class="sub-pin"
          type="button"
          aria-pressed="false"
          aria-label="Pin sub navigation"
          title="Pin sub navigation">
    <!-- minimalist pin icon -->
    <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
      <path d="M9 3l6 6-2 2 4 4-2 2-4-4-2 2-6-6 6-6z" fill="none" stroke="currentColor" stroke-width="1.5" />
    </svg>
  </button>

  <nav>
    <ul id="sub-sidebar-links"></ul>
  </nav>
  
  <!-- Expose both the legacy href-only map and the new item map -->
  <script define:vars={{ SUBPAGES, SUBPAGE_ITEMS, SUB_ICONS }}>
    window.__SUBPAGES__ = SUBPAGES;               // legacy (href arrays)
    window.__SUBPAGE_ITEMS__ = SUBPAGE_ITEMS;     // new (href + label [+ icon, order])
    window.__SUB_ICONS__ = SUB_ICONS;

  </script>
</aside>